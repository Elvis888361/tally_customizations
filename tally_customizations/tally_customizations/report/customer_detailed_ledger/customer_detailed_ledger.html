<!DOCTYPE html>
<html>
<head>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    background: white;
    padding: 20px;
    font-size: 9pt;
}

.statement-container {
    max-width: 100%;
    margin: 0 auto;
}

/* Company Header Table */
.company-header-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
}

.company-name {
    font-weight: bold;
    font-size: 14pt;
    text-align: right;
}

.company-address {
    font-size: 9pt;
    line-height: 1.4;
    text-align: right;
    padding-top: 2px;
}

/* Customer Section Table */
.customer-section-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    border: 1px solid #000;
}

.customer-label {
    background-color: white;
    color: #000;
    padding: 8px 15px;
    font-weight: bold;
    font-size: 9pt;
    border: 1px solid #000;
}

.customer-details {
    padding: 10px 15px;
    vertical-align: top;
}

.customer-name-main {
    font-weight: bold;
    font-size: 10pt;
    margin-bottom: 2px;
}

.customer-name-repeat {
    font-size: 9pt;
    margin-bottom: 2px;
}

.customer-contact {
    font-size: 9pt;
    color: #333;
}

/* Account Summary */
.summary-header {
    background-color: white;
    color: #000;
    padding: 8px 15px;
    font-weight: bold;
    font-size: 9pt;
    border: 1px solid #000;
}

.summary-dates {
    font-size: 8.5pt;
    font-weight: normal;
    float: right;
}

.summary-table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
}

.summary-table td {
    padding: 8px 15px;
    font-size: 9pt;
    border: 1px solid #000;
}

.summary-label {
    text-align: left;
}

.summary-value {
    text-align: right;
}

/* Period Header */
.period-header {
    text-align: center;
    font-weight: bold;
    margin: 20px 0 15px 0;
    font-size: 9pt;
}

/* Transaction Table */
.transaction-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 8.5pt;
    border: 1px solid #000;
}

.transaction-table thead {
    background-color: white;
    color: #000;
}

.transaction-table thead th {
    padding: 10px 8px;
    text-align: left;
    font-weight: bold;
    border: 1px solid #000;
    font-size: 8.5pt;
}

.transaction-table tbody td {
    padding: 10px 8px;
    border: 1px solid #000;
    vertical-align: top;
    background-color: white;
}

.text-right {
    text-align: right;
}

.text-center {
    text-align: center;
}

/* Product Table */
.product-table-cell {
    padding: 0 !important;
    background-color: white !important;
}

.product-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
    font-size: 8pt;
}

.product-table thead {
    background-color: white;
    color: #000;
}

.product-table thead th {
    padding: 8px 6px;
    text-align: left;
    font-weight: bold;
    border: 1px solid #000;
    font-size: 8pt;
}

.product-table tbody td {
    padding: 8px 6px;
    border: 1px solid #000;
    background-color: white;
    font-size: 8pt;
}

@media print {
    body {
        padding: 10px;
    }
}
</style>
</head>
<body>
<div class="statement-container">
    <!-- Company Header -->
    <table class="company-header-table">
        <tr>
            <td class="company-name">
                {{ filters.company or company }}
            </td>
        </tr>
        <tr>
            <td class="company-address">
                {% set company_doc = frappe.get_doc("Company", filters.company or company) %}
                {{ company_doc.city or "Kampala" }}, {{ company_doc.country or "Central Uganda" }}, {{ company_doc.pincode or "126876" }}
            </td>
        </tr>
    </table>

    <!-- Customer and Summary Section -->
    <table class="customer-section-table">
        <tr>
            <!-- Customer Box -->
            <td style="width: 30%; vertical-align: top;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td class="customer-label">Customer:</td>
                    </tr>
                    <tr>
                        <td class="customer-details">
                            {% set customer_doc = frappe.get_doc("Customer", filters.customer) %}
                            <div class="customer-name-main">{{ customer_doc.customer_name|upper }}</div>
                            <div class="customer-name-repeat">{{ customer_doc.customer_name }}</div>
                            {% if customer_doc.mobile_no %}
                            <div class="customer-contact">Mobile: {{ customer_doc.mobile_no }}</div>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </td>

            <!-- Spacer -->
            <td style="width: 5%;"></td>

            <!-- Account Summary Box -->
            <td style="width: 65%; vertical-align: top;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td class="summary-header" colspan="2">
                            Account Summary
                            <span class="summary-dates">{{ frappe.utils.formatdate(filters.from_date, "dd/MM/yyyy") }} To {{ frappe.utils.formatdate(filters.to_date, "dd/MM/yyyy") }}</span>
                        </td>
                    </tr>
                </table>
                <table class="summary-table">
                    {% set opening_balance = data[0].debit if data and data[0].type == "Opening Balance" else 0 %}
                    {% set total_invoices = 0 %}
                    {% set total_payments = 0 %}
                    {% for row in data %}
                        {% if row.type == "Invoice" %}
                            {% set total_invoices = total_invoices + row.debit %}
                        {% elif row.type == "Payment" %}
                            {% set total_payments = total_payments + row.credit %}
                        {% endif %}
                    {% endfor %}
                    {% set closing_balance = opening_balance + total_invoices - total_payments %}
                    <tr>
                        <td class="summary-label">Opening Balance</td>
                        <td class="summary-value">{{ data[0].currency if data else "UGX" }} {{ "{:,.0f}".format(opening_balance) }}</td>
                    </tr>
                    <tr>
                        <td class="summary-label">Total Invoice</td>
                        <td class="summary-value">{{ data[0].currency if data else "UGX" }} {{ "{:,.0f}".format(total_invoices) }}</td>
                    </tr>
                    <tr>
                        <td class="summary-label">Paid Amount</td>
                        <td class="summary-value">{{ data[0].currency if data else "UGX" }} {{ "{:,.0f}".format(total_payments) }}</td>
                    </tr>
                    <tr>
                        <td class="summary-label">Credit</td>
                        <td class="summary-value">{{ data[0].currency if data else "UGX" }} {{ "{:,.0f}".format(total_invoices - total_payments) }}</td>
                    </tr>
                    <tr>
                        <td class="summary-label">Balance due</td>
                        <td class="summary-value">{{ data[0].currency if data else "UGX" }} {{ "{:,.0f}".format(closing_balance) }}</td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <!-- Period Header -->
    <div class="period-header">
        Showing all invoices and payments between {{ frappe.utils.formatdate(filters.from_date, "dd/MM/yyyy") }} and {{ frappe.utils.formatdate(filters.to_date, "dd/MM/yyyy") }}
    </div>

    <!-- Transaction Table -->
    <table class="transaction-table">
        <thead>
            <tr>
                <th style="width: 12%;">Date</th>
                <th style="width: 7%;">Ref No.</th>
                <th style="width: 8%;">Type</th>
                <th style="width: 9%;">Location</th>
                <th style="width: 9%;">Payment<br>Status</th>
                <th style="width: 11%;" class="text-right">Debit</th>
                <th style="width: 11%;" class="text-right">Credit</th>
                <th style="width: 10%;" class="text-right">Balance</th>
                <th style="width: 11%;">Payment<br>Method</th>
                <th style="width: 12%;">Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr>
                <td>{{ frappe.utils.formatdate(row.posting_date, "dd/MM/yyyy") }}
                {% if row.posting_time %} {{ (row.posting_time|string)[:5] }} AM{% endif %}</td>
                <td>{{ row.ref_no.split("-")[-1] if row.ref_no and "-" in row.ref_no else row.ref_no }}</td>
                <td>{{ row.type }}</td>
                <td>{{ row.location }}</td>
                <td>{{ row.payment_status }}</td>
                <td class="text-right">{% if row.debit %}{{ row.currency }}<br>{{ "{:,.0f}".format(row.debit) }}{% endif %}</td>
                <td class="text-right">{% if row.credit %}{{ row.currency }}<br>{{ "{:,.0f}".format(row.credit) }}{% endif %}</td>
                <td class="text-right">{{ "{:,.0f}".format(row.balance) }}<br>{{ row.balance_type }}</td>
                <td>{{ row.payment_method }}</td>
                <td>{{ row.notes }}</td>
            </tr>

            <!-- Product Details Row (only for invoices) -->
            {% if row.type == "Invoice" and row.items %}
            <tr>
                <td colspan="10" class="product-table-cell">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th style="width: 3%; text-align: center;">#</th>
                                <th style="width: 25%;">Product</th>
                                <th style="width: 10%; text-align: right;">Quantity</th>
                                <th style="width: 12%; text-align: right;">Unit Price</th>
                                <th style="width: 10%; text-align: right;">Discount</th>
                                <th style="width: 8%; text-align: right;">Tax</th>
                                <th style="width: 14%; text-align: right;">Price Inc. tax</th>
                                <th style="width: 18%; text-align: right;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in row.items %}
                            <tr>
                                <td style="text-align: center;">{{ loop.index }}</td>
                                <td>{{ item.item_name }} {{ item.item_code }}</td>
                                <td style="text-align: right;">{{ "{:,.0f}".format(item.qty) }} {{ item.uom or "Pc(s)" }}</td>
                                <td style="text-align: right;">{{ row.currency }} {{ "{:,.0f}".format(item.rate) }}</td>
                                <td style="text-align: right;">{{ row.currency }} {{ "{:,.0f}".format(item.discount_amount or 0) }}</td>
                                <td style="text-align: right;">{{ row.currency }} 0</td>
                                <td style="text-align: right;">{{ row.currency }} {{ "{:,.0f}".format(item.rate) }}</td>
                                <td style="text-align: right;">{{ row.currency }} {{ "{:,.0f}".format(item.amount) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
</body>
</html>
